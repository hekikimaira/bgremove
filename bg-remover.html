<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>èƒŒæ™¯é€éãƒ„ãƒ¼ãƒ«</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;500;700&display=swap');

  :root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-card: #1a1a28;
    --bg-hover: #222236;
    --accent: #6c5ce7;
    --accent-glow: rgba(108, 92, 231, 0.3);
    --accent-bright: #a29bfe;
    --success: #00d2d3;
    --warning: #feca57;
    --danger: #ff6b6b;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a8;
    --text-dim: #555570;
    --border: #2a2a40;
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      linear-gradient(rgba(108,92,231,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(108,92,231,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 640px;
    margin: 0 auto;
    padding: 16px;
    padding-bottom: 100px;
  }

  .header {
    text-align: center;
    padding: 24px 0 20px;
  }

  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent-bright), var(--success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* iOSå¯¾å¿œ: labelã§inputã‚’ãƒ©ãƒƒãƒ— */
  .file-select-area {
    text-align: center;
    margin-bottom: 16px;
  }

  .file-label {
    display: block;
    padding: 20px 32px;
    background: var(--accent);
    color: white;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
    text-align: center;
  }

  .file-label:active {
    background: var(--accent-bright);
    transform: scale(0.98);
  }

  .file-label input[type="file"] {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    background: var(--bg-secondary);
    color: var(--text-dim);
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(108,92,231,0.05);
  }

  .settings {
    margin-top: 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 16px;
    border: 1px solid var(--border);
  }

  .settings-title {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
  }

  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .setting-row label {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .setting-row select {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.85rem;
    font-family: 'Noto Sans JP', sans-serif;
    outline: none;
    -webkit-appearance: none;
  }

  .notice {
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    background: rgba(254,202,87,0.08);
    border: 1px solid rgba(254,202,87,0.2);
    color: var(--warning);
    font-size: 0.75rem;
    line-height: 1.5;
  }

  .processing { display: none; margin-top: 24px; text-align: center; }
  .processing.active { display: block; }

  .progress-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 32px 24px;
    border: 1px solid var(--border);
  }

  .spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-text { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px; }

  .progress-bar-track {
    width: 100%; height: 4px;
    background: var(--bg-card); border-radius: 2px; overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-detail { font-size: 0.65rem; color: var(--text-dim); margin-top: 8px; }

  .results { display: none; margin-top: 24px; }
  .results.active { display: block; }

  .compare-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .compare-tabs { display: flex; border-bottom: 1px solid var(--border); }

  .compare-tab {
    flex: 1; padding: 12px; text-align: center;
    font-size: 0.8rem; font-weight: 500; cursor: pointer;
    color: var(--text-secondary); background: transparent;
    border: none; font-family: 'Noto Sans JP', sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .compare-tab.active {
    color: var(--accent-bright);
    background: var(--bg-card);
    box-shadow: inset 0 -2px 0 var(--accent);
  }

  .image-display { display: none; width: 100%; }
  .image-display.active { display: block; }
  .image-display img { display: block; width: 100%; height: auto; }

  .checker-bg {
    background-image:
      linear-gradient(45deg, #1a1a28 25%, transparent 25%),
      linear-gradient(-45deg, #1a1a28 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #1a1a28 75%),
      linear-gradient(-45deg, transparent 75%, #1a1a28 75%);
    background-size: 16px 16px;
    background-position: 0 0, 0 8px, 8px -8px, -8px 0;
    background-color: #0f0f1a;
  }

  .actions {
    display: flex; gap: 8px; padding: 12px;
    border-top: 1px solid var(--border);
  }

  .btn {
    flex: 1; padding: 12px 16px; border: none; border-radius: 8px;
    font-size: 0.85rem; font-weight: 500;
    font-family: 'Noto Sans JP', sans-serif;
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:active { background: var(--accent-bright); }
  .btn-secondary {
    background: var(--bg-card); color: var(--text-secondary);
    border: 1px solid var(--border);
  }
  .btn-secondary:active { background: var(--bg-hover); }

  .btn-reset {
    margin-top: 12px; width: 100%; padding: 12px;
    background: transparent; color: var(--text-dim);
    border: 1px dashed var(--border); border-radius: 8px;
    font-size: 0.8rem; cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
  }

  .status {
    margin-top: 12px; padding: 10px 14px; border-radius: 8px;
    font-size: 0.8rem; display: none;
  }
  .status.active { display: block; }
  .status.error {
    background: rgba(255,107,107,0.1);
    border: 1px solid rgba(255,107,107,0.3);
    color: var(--danger);
  }
  .status.success {
    background: rgba(0,210,211,0.1);
    border: 1px solid rgba(0,210,211,0.3);
    color: var(--success);
  }

  .batch-list { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }

  .batch-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; background: var(--bg-secondary);
    border: 1px solid var(--border); border-radius: 8px;
  }
  .batch-item-thumb {
    width: 40px; height: 40px; border-radius: 6px;
    object-fit: cover; background: var(--bg-card);
  }
  .batch-item-info { flex: 1; overflow: hidden; }
  .batch-item-name {
    white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; font-size: 0.8rem;
  }
  .batch-item-status { font-size: 0.7rem; color: var(--text-dim); }
  .batch-item-status.done { color: var(--success); }
  .batch-item-status.fail { color: var(--danger); }
  .batch-item-btn {
    padding: 6px 10px; border: none; border-radius: 6px;
    background: var(--bg-card); color: var(--text-secondary);
    font-size: 0.75rem; cursor: pointer;
  }

  .footer {
    text-align: center; margin-top: 32px;
    font-size: 0.65rem; color: var(--text-dim);
  }
  .footer a { color: var(--accent-bright); text-decoration: none; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>ğŸ”ª èƒŒæ™¯é€éãƒ„ãƒ¼ãƒ«</h1>
    <p>ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµ Â· ã‚µãƒ¼ãƒãƒ¼ä¸è¦ Â· ç„¡åˆ¶é™</p>
  </div>

  <div id="inputSection">
    <div class="file-select-area">
      <label class="file-label">
        ğŸ“ ç”»åƒã‚’é¸æŠ
        <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp,image/*" multiple>
      </label>
    </div>

    <div class="drop-zone" id="dropZone">
      ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚OKï¼ˆPCå‘ã‘ï¼‰<br>
      PNG / JPG / WebP Â· è¤‡æ•°é¸æŠå¯¾å¿œ
    </div>

    <div class="settings">
      <div class="settings-title">âš™ è¨­å®š</div>
      <div class="setting-row">
        <label>ãƒ¢ãƒ‡ãƒ«å“è³ª</label>
        <select id="modelSelect">
          <option value="isnet_fp16">æ¨™æº– (fp16)</option>
          <option value="isnet_quint8">è»½é‡ (quint8)</option>
          <option value="isnet">é«˜å“è³ª (fp32)</option>
        </select>
      </div>
    </div>

    <div class="notice">
      âš¡ åˆå›ã¯ãƒ¢ãƒ‡ãƒ«DLã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼ˆ2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ï¼‰<br>
      â€» GitHub Pagesç­‰ã®HTTPSç’°å¢ƒã§å‹•ä½œã—ã¾ã™
    </div>
  </div>

  <div class="processing" id="processing">
    <div class="progress-container">
      <div class="spinner"></div>
      <div class="progress-text" id="progressText">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
      <div class="progress-detail" id="progressDetail"></div>
    </div>
  </div>

  <div class="status" id="status"></div>

  <div class="results" id="results">
    <div class="compare-container">
      <div class="compare-tabs">
        <button class="compare-tab active" id="tabResult">é€éçµæœ</button>
        <button class="compare-tab" id="tabOriginal">å…ƒç”»åƒ</button>
      </div>
      <div>
        <div class="image-display checker-bg active" id="resultView">
          <img id="resultImg" alt="çµæœ">
        </div>
        <div class="image-display" id="originalView">
          <img id="originalImg" alt="å…ƒç”»åƒ">
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="btnDownload">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-secondary" id="btnCopy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <button class="btn-reset" id="btnReset">ğŸ”„ æ–°ã—ã„ç”»åƒã‚’å‡¦ç†</button>
  </div>

  <div class="batch-list" id="batchList"></div>

  <div class="footer">
    powered by <a href="https://github.com/imgly/background-removal-js" target="_blank">@imgly/background-removal</a>
  </div>
</div>

<script type="module">
let removeBackground = null;
let libReady = false;

async function ensureLib() {
  if (libReady) return true;
  // Try multiple CDN sources
  const sources = [
    'https://esm.sh/@imgly/background-removal@1.5.13',
    'https://esm.run/@imgly/background-removal@1.5.13',
    'https://cdn.skypack.dev/@imgly/background-removal@1.5.13'
  ];
  for (const src of sources) {
    try {
      const mod = await import(src);
      removeBackground = mod.default || mod.removeBackground;
      if (typeof removeBackground === 'function') {
        libReady = true;
        console.log('Library loaded from:', src);
        return true;
      }
    } catch(e) {
      console.warn('Failed:', src, e.message);
    }
  }
  return false;
}

const $ = id => document.getElementById(id);
const inputSection = $('inputSection');
const fileInput = $('fileInput');
const dropZone = $('dropZone');
const processing = $('processing');
const progressText = $('progressText');
const progressBar = $('progressBar');
const progressDetail = $('progressDetail');
const results = $('results');
const resultImg = $('resultImg');
const originalImg = $('originalImg');
const statusEl = $('status');
const batchList = $('batchList');
const modelSelect = $('modelSelect');

let currentBlob = null;
let currentFileName = 'output.png';

// === Events ===

fileInput.addEventListener('change', function() {
  const files = Array.from(this.files).filter(f => f.type.startsWith('image/'));
  if (files.length > 0) handleFiles(files);
  this.value = '';
});

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  if (files.length > 0) handleFiles(files);
});

$('tabResult').addEventListener('click', () => {
  $('tabResult').classList.add('active');
  $('tabOriginal').classList.remove('active');
  $('resultView').classList.add('active');
  $('originalView').classList.remove('active');
});

$('tabOriginal').addEventListener('click', () => {
  $('tabOriginal').classList.add('active');
  $('tabResult').classList.remove('active');
  $('originalView').classList.add('active');
  $('resultView').classList.remove('active');
});

$('btnDownload').addEventListener('click', () => {
  if (!currentBlob) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(currentBlob);
  a.download = currentFileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

$('btnCopy').addEventListener('click', async () => {
  if (!currentBlob) return;
  try {
    await navigator.clipboard.write([new ClipboardItem({ 'image/png': currentBlob })]);
    showStatus('success', 'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  } catch { showStatus('error', 'âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ï¼‰'); }
});

$('btnReset').addEventListener('click', resetAll);

function resetAll() {
  results.classList.remove('active');
  processing.classList.remove('active');
  inputSection.classList.remove('hidden');
  batchList.innerHTML = '';
  statusEl.classList.remove('active');
  currentBlob = null;
}

function showStatus(type, msg) {
  if (!msg) { statusEl.classList.remove('active'); return; }
  statusEl.className = 'status active ' + type;
  statusEl.textContent = msg;
  if (type === 'success') setTimeout(() => statusEl.classList.remove('active'), 5000);
}

// === Processing ===

async function handleFiles(files) {
  inputSection.classList.add('hidden');
  processing.classList.add('active');

  if (!libReady) {
    progressText.textContent = 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...';
    progressBar.style.width = '5%';
    progressDetail.textContent = 'CDNã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­';
    const ok = await ensureLib();
    if (!ok) {
      processing.classList.remove('active');
      inputSection.classList.remove('hidden');
      showStatus('error', 'âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—ã€‚HTTPSç’°å¢ƒã§é–‹ã„ã¦ãã ã•ã„ã€‚');
      return;
    }
  }

  if (files.length === 1) {
    await processSingle(files[0]);
  } else {
    await processBatch(files);
  }
}

async function processSingle(file) {
  showStatus('', '');
  results.classList.remove('active');
  batchList.innerHTML = '';

  try {
    originalImg.src = URL.createObjectURL(file);
    progressText.textContent = 'èƒŒæ™¯ã‚’è§£æä¸­...';
    progressBar.style.width = '10%';
    progressDetail.textContent = modelSelect.value;

    const blob = await removeBackground(file, {
      model: modelSelect.value,
      progress: (key, cur, tot) => {
        if (!tot) return;
        const pct = Math.round((cur / tot) * 100);
        progressBar.style.width = Math.min(pct, 95) + '%';
        if (key && (key.includes('onnx') || key.includes('model'))) {
          progressText.textContent = 'ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
          progressDetail.textContent = (cur/1048576).toFixed(1) + 'MB / ' + (tot/1048576).toFixed(1) + 'MB';
        } else {
          progressText.textContent = 'èƒŒæ™¯ã‚’è§£æä¸­...';
          progressDetail.textContent = pct + '%';
        }
      }
    });

    currentBlob = blob;
    currentFileName = file.name.replace(/\.[^.]+$/, '') + '_transparent.png';
    resultImg.src = URL.createObjectURL(blob);
    progressBar.style.width = '100%';
    processing.classList.remove('active');
    results.classList.add('active');
    showStatus('success', 'âœ… å®Œäº†');
  } catch (err) {
    processing.classList.remove('active');
    inputSection.classList.remove('hidden');
    showStatus('error', 'âŒ ' + err.message);
    console.error(err);
  }
}

async function processBatch(files) {
  showStatus('', '');
  results.classList.remove('active');
  batchList.innerHTML = '';
  let done = 0;

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    progressText.textContent = 'å‡¦ç†ä¸­ (' + (i+1) + '/' + files.length + ')';
    progressBar.style.width = (i / files.length * 100) + '%';
    progressDetail.textContent = file.name;

    const el = document.createElement('div');
    el.className = 'batch-item';
    const thumb = document.createElement('img');
    thumb.className = 'batch-item-thumb';
    thumb.src = URL.createObjectURL(file);
    const info = document.createElement('div');
    info.className = 'batch-item-info';
    const nm = document.createElement('div');
    nm.className = 'batch-item-name';
    nm.textContent = file.name;
    const st = document.createElement('div');
    st.className = 'batch-item-status';
    st.textContent = 'å‡¦ç†ä¸­...';
    info.appendChild(nm);
    info.appendChild(st);
    const acts = document.createElement('div');
    el.appendChild(thumb);
    el.appendChild(info);
    el.appendChild(acts);
    batchList.appendChild(el);

    try {
      const blob = await removeBackground(file, {
        model: modelSelect.value,
        progress: (key, cur, tot) => {
          if (tot > 0) progressBar.style.width = (((i + cur/tot) / files.length) * 100) + '%';
        }
      });
      const outName = file.name.replace(/\.[^.]+$/, '') + '_transparent.png';
      st.textContent = 'å®Œäº†';
      st.className = 'batch-item-status done';
      const btn = document.createElement('button');
      btn.className = 'batch-item-btn';
      btn.textContent = 'ğŸ’¾';
      btn.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = outName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
      acts.appendChild(btn);
      done++;
    } catch (err) {
      st.textContent = 'ã‚¨ãƒ©ãƒ¼';
      st.className = 'batch-item-status fail';
      console.error(err);
    }
  }

  progressBar.style.width = '100%';
  processing.classList.remove('active');
  showStatus('success', 'âœ… ' + done + '/' + files.length + ' æšå®Œäº†');

  const rb = document.createElement('button');
  rb.className = 'btn-reset';
  rb.textContent = 'ğŸ”„ æ–°ã—ã„ç”»åƒã‚’å‡¦ç†';
  rb.addEventListener('click', resetAll);
  batchList.appendChild(rb);
}
</script>

</body>
</html>
