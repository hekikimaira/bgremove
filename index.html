<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>èƒŒæ™¯é€éãƒ„ãƒ¼ãƒ«</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;500;700&display=swap');

  :root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-card: #1a1a28;
    --accent: #6c5ce7;
    --accent-glow: rgba(108,92,231,0.3);
    --accent-bright: #a29bfe;
    --success: #00d2d3;
    --warning: #feca57;
    --danger: #ff6b6b;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a8;
    --text-dim: #555570;
    --border: #2a2a40;
    --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg-primary); color: var(--text-primary);
    min-height: 100dvh;
  }
  .app {
    max-width: 640px; margin: 0 auto;
    padding: 16px; padding-bottom: 100px;
  }
  .header { text-align: center; padding: 24px 0 20px; }
  .header h1 {
    font-size: 1.5rem; font-weight: 700;
    background: linear-gradient(135deg, var(--accent-bright), var(--success));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }

  .file-label {
    display: block; padding: 20px; text-align: center;
    background: var(--accent); color: white; border-radius: var(--radius);
    font-size: 1rem; font-weight: 500; cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: all 0.2s;
  }
  .file-label:active { background: var(--accent-bright); transform: scale(0.98); }
  .file-label input[type="file"] {
    position: absolute; width: 1px; height: 1px;
    opacity: 0; overflow: hidden;
  }

  .drop-zone {
    margin-top: 12px; border: 2px dashed var(--border);
    border-radius: var(--radius); padding: 20px; text-align: center;
    background: var(--bg-secondary); color: var(--text-dim); font-size: 0.8rem;
  }
  .drop-zone.drag-over { border-color: var(--accent); }

  .notice {
    margin-top: 10px; padding: 8px 12px; border-radius: 8px;
    background: rgba(254,202,87,0.08); border: 1px solid rgba(254,202,87,0.2);
    color: var(--warning); font-size: 0.72rem; line-height: 1.5;
  }

  .processing { display:none; margin-top:24px; text-align:center; }
  .processing.active { display:block; }
  .progress-box {
    background: var(--bg-secondary); border-radius: var(--radius);
    padding: 32px 24px; border: 1px solid var(--border);
  }
  .spinner {
    width:44px; height:44px; border:3px solid var(--border);
    border-top-color: var(--accent); border-radius:50%;
    animation: spin 1s linear infinite; margin: 0 auto 14px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .progress-text { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px; }
  .progress-bar-track {
    width:100%; height:4px; background:var(--bg-card);
    border-radius:2px; overflow:hidden;
  }
  .progress-bar-fill {
    height:100%; background:linear-gradient(90deg, var(--accent), var(--success));
    border-radius:2px; transition: width 0.3s; width:0%;
  }
  .progress-detail { font-size:0.65rem; color:var(--text-dim); margin-top:6px; }

  .results { display:none; margin-top:24px; }
  .results.active { display:block; }
  .compare-box {
    background: var(--bg-secondary); border-radius: var(--radius);
    border: 1px solid var(--border); overflow: hidden;
  }
  .tabs { display:flex; border-bottom:1px solid var(--border); }
  .tab {
    flex:1; padding:12px; text-align:center; font-size:0.8rem;
    cursor:pointer; color:var(--text-secondary); background:transparent;
    border:none; font-family:'Noto Sans JP',sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .tab.active {
    color:var(--accent-bright); background:var(--bg-card);
    box-shadow: inset 0 -2px 0 var(--accent);
  }
  .img-view { display:none; width:100%; }
  .img-view.active { display:block; }
  .img-view img { display:block; width:100%; height:auto; }
  .checker-bg {
    background-image:
      linear-gradient(45deg, #1a1a28 25%, transparent 25%),
      linear-gradient(-45deg, #1a1a28 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #1a1a28 75%),
      linear-gradient(-45deg, transparent 75%, #1a1a28 75%);
    background-size:16px 16px;
    background-position:0 0, 0 8px, 8px -8px, -8px 0;
    background-color:#0f0f1a;
  }
  .actions {
    display:flex; gap:8px; padding:12px;
    border-top:1px solid var(--border);
  }
  .btn {
    flex:1; padding:12px; border:none; border-radius:8px;
    font-size:0.85rem; font-weight:500; cursor:pointer;
    font-family:'Noto Sans JP',sans-serif;
    display:flex; align-items:center; justify-content:center; gap:6px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary { background:var(--accent); color:white; }
  .btn-primary:active { background:var(--accent-bright); }
  .btn-secondary {
    background:var(--bg-card); color:var(--text-secondary);
    border:1px solid var(--border);
  }
  .btn-reset {
    margin-top:12px; width:100%; padding:12px;
    background:transparent; color:var(--text-dim);
    border:1px dashed var(--border); border-radius:8px;
    font-size:0.8rem; cursor:pointer; font-family:'Noto Sans JP',sans-serif;
  }

  .status {
    margin-top:12px; padding:10px 14px; border-radius:8px;
    font-size:0.8rem; display:none;
  }
  .status.active { display:block; }
  .status.error { background:rgba(255,107,107,0.1); border:1px solid rgba(255,107,107,0.3); color:var(--danger); }
  .status.success { background:rgba(0,210,211,0.1); border:1px solid rgba(0,210,211,0.3); color:var(--success); }

  .hidden { display:none !important; }

  .footer {
    text-align:center; margin-top:32px;
    font-size:0.65rem; color:var(--text-dim);
  }
  .footer a { color:var(--accent-bright); text-decoration:none; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>ğŸ”ª èƒŒæ™¯é€éãƒ„ãƒ¼ãƒ«</h1>
    <p>Transformers.js Â· ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµ Â· ç„¡åˆ¶é™</p>
  </div>

  <div id="inputSection">
    <label class="file-label">
      ğŸ“ ç”»åƒã‚’é¸æŠ
      <input type="file" id="fileInput" accept="image/*" multiple>
    </label>
    <div class="drop-zone" id="dropZone">
      ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚OK Â· PNG/JPG/WebP
    </div>
    <div class="notice">
      âš¡ åˆå›ã¯AIãƒ¢ãƒ‡ãƒ«(ç´„45MB)ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§é«˜é€Ÿã€‚
    </div>
  </div>

  <div class="processing" id="processing">
    <div class="progress-box">
      <div class="spinner"></div>
      <div class="progress-text" id="progressText">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
      <div class="progress-detail" id="progressDetail"></div>
    </div>
  </div>

  <div class="status" id="status"></div>

  <div class="results" id="results">
    <div class="compare-box">
      <div class="tabs">
        <button class="tab active" id="tabResult">é€éçµæœ</button>
        <button class="tab" id="tabOriginal">å…ƒç”»åƒ</button>
      </div>
      <div class="img-view checker-bg active" id="resultView">
        <img id="resultImg">
      </div>
      <div class="img-view" id="originalView">
        <img id="originalImg">
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="btnDownload">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-secondary" id="btnCopy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <button class="btn-reset" id="btnReset">ğŸ”„ æ–°ã—ã„ç”»åƒã‚’å‡¦ç†</button>
  </div>

  <div class="footer">
    powered by <a href="https://huggingface.co/docs/transformers.js" target="_blank">Transformers.js</a> + <a href="https://huggingface.co/briaai/RMBG-1.4" target="_blank">RMBG-1.4</a>
  </div>
</div>

<script type="module">
  // jsdelivr CDN for Transformers.js v3
  import { AutoModel, AutoProcessor, RawImage, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.4.1';

  // Disable local model check
  env.allowLocalModels = false;

  const $ = id => document.getElementById(id);
  const inputSection = $('inputSection');
  const fileInput = $('fileInput');
  const dropZone = $('dropZone');
  const processing = $('processing');
  const progressText = $('progressText');
  const progressBar = $('progressBar');
  const progressDetail = $('progressDetail');
  const results = $('results');
  const resultImg = $('resultImg');
  const originalImg = $('originalImg');
  const statusEl = $('status');

  let model = null;
  let processor = null;
  let currentBlob = null;
  let currentFileName = 'output.png';

  // === Load model ===
  async function ensureModel() {
    if (model && processor) return;

    progressText.textContent = 'AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
    progressBar.style.width = '15%';
    progressDetail.textContent = 'briaai/RMBG-1.4 (åˆå›ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)';

    model = await AutoModel.from_pretrained('briaai/RMBG-1.4', {
      config: { model_type: 'custom' },
    });

    progressBar.style.width = '40%';
    progressText.textContent = 'ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’èª­ã¿è¾¼ã¿ä¸­...';

    processor = await AutoProcessor.from_pretrained('briaai/RMBG-1.4', {
      config: {
        do_normalize: true,
        do_pad: false,
        do_rescale: true,
        do_resize: true,
        image_mean: [0.5, 0.5, 0.5],
        image_std: [1, 1, 1],
        size: { width: 1024, height: 1024 },
      }
    });

    progressBar.style.width = '50%';
  }

  // === Process image ===
  async function processImage(file) {
    showStatus('', '');
    results.classList.remove('active');
    processing.classList.add('active');
    inputSection.classList.add('hidden');

    try {
      await ensureModel();

      // Show original
      const origURL = URL.createObjectURL(file);
      originalImg.src = origURL;

      progressText.textContent = 'ç”»åƒã‚’è§£æä¸­...';
      progressBar.style.width = '55%';
      progressDetail.textContent = file.name;

      // Load image
      const img = await RawImage.fromURL(origURL);

      progressBar.style.width = '65%';
      progressText.textContent = 'èƒŒæ™¯ã‚’é™¤å»ä¸­...';

      // Process
      const { pixel_values } = await processor(img);

      progressBar.style.width = '75%';

      // Predict
      const { output } = await model({ input: pixel_values });

      progressBar.style.width = '85%';
      progressText.textContent = 'ãƒã‚¹ã‚¯ã‚’é©ç”¨ä¸­...';

      // Post-process: get mask from output tensor
      // output shape: [batch, channels, H, W] e.g. [1, 1, 1024, 1024]
      const maskTensor = output[0];
      // Clamp 0-1, scale to 255
      const maskClamped = maskTensor.clamp(0, 1).mul(255).to('uint8');

      // Get raw data and dims
      const maskDims = maskClamped.dims; // e.g. [1, 1024, 1024] or [1, 1, 1024, 1024]
      const maskH = maskDims[maskDims.length - 2];
      const maskW = maskDims[maskDims.length - 1];
      const maskFlat = maskClamped.data; // flat Uint8Array

      // Resize mask to original image size using a temp canvas
      const maskCanvas = document.createElement('canvas');
      maskCanvas.width = maskW;
      maskCanvas.height = maskH;
      const maskCtx = maskCanvas.getContext('2d');
      const maskImgData = maskCtx.createImageData(maskW, maskH);
      const totalMaskPx = maskW * maskH;
      // maskFlat may have more elements if multi-dim; just use last WxH
      const offset = maskFlat.length - totalMaskPx;
      for (let i = 0; i < totalMaskPx; i++) {
        const v = maskFlat[offset + i];
        maskImgData.data[i * 4]     = v;
        maskImgData.data[i * 4 + 1] = v;
        maskImgData.data[i * 4 + 2] = v;
        maskImgData.data[i * 4 + 3] = 255;
      }
      maskCtx.putImageData(maskImgData, 0, 0);

      // Resize to original dimensions
      const resizeCanvas = document.createElement('canvas');
      resizeCanvas.width = img.width;
      resizeCanvas.height = img.height;
      const resizeCtx = resizeCanvas.getContext('2d');
      resizeCtx.drawImage(maskCanvas, 0, 0, img.width, img.height);
      const resizedData = resizeCtx.getImageData(0, 0, img.width, img.height).data;

      // Extract just the R channel as alpha values
      const maskData = new Uint8Array(img.width * img.height);
      for (let i = 0; i < maskData.length; i++) {
        maskData[i] = resizedData[i * 4]; // R channel = mask value
      }

      // Create output canvas
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');

      // Compose: original RGB + mask as alpha
      const imgData = ctx.createImageData(img.width, img.height);
      const srcChannels = img.channels; // typically 3 (RGB) or 4 (RGBA)
      const totalPixels = img.width * img.height;

      for (let i = 0; i < totalPixels; i++) {
        const srcIdx = i * srcChannels;
        const dstIdx = i * 4;
        imgData.data[dstIdx]     = img.data[srcIdx];     // R
        imgData.data[dstIdx + 1] = img.data[srcIdx + 1]; // G
        imgData.data[dstIdx + 2] = img.data[srcIdx + 2]; // B
        imgData.data[dstIdx + 3] = maskData[i];           // A from mask
      }
      ctx.putImageData(imgData, 0, 0);

      progressBar.style.width = '95%';

      // Convert to blob
      const blob = await new Promise(resolve =>
        canvas.toBlob(resolve, 'image/png')
      );

      currentBlob = blob;
      currentFileName = file.name.replace(/\.[^.]+$/, '') + '_transparent.png';
      resultImg.src = URL.createObjectURL(blob);

      progressBar.style.width = '100%';
      processing.classList.remove('active');
      results.classList.add('active');
      showStatus('success', 'âœ… èƒŒæ™¯é€éãŒå®Œäº†ã—ã¾ã—ãŸ');

    } catch(err) {
      processing.classList.remove('active');
      inputSection.classList.remove('hidden');
      showStatus('error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + err.message);
      console.error(err);
    }
  }

  // === Events ===
  fileInput.addEventListener('change', function() {
    const files = Array.from(this.files).filter(f => f.type.startsWith('image/'));
    if (files.length > 0) processImage(files[0]);
    this.value = '';
  });

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    if (files.length > 0) processImage(files[0]);
  });

  $('tabResult').addEventListener('click', () => {
    $('tabResult').classList.add('active'); $('tabOriginal').classList.remove('active');
    $('resultView').classList.add('active'); $('originalView').classList.remove('active');
  });
  $('tabOriginal').addEventListener('click', () => {
    $('tabOriginal').classList.add('active'); $('tabResult').classList.remove('active');
    $('originalView').classList.add('active'); $('resultView').classList.remove('active');
  });

  $('btnDownload').addEventListener('click', () => {
    if (!currentBlob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(currentBlob);
    a.download = currentFileName;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  $('btnCopy').addEventListener('click', async () => {
    if (!currentBlob) return;
    try {
      await navigator.clipboard.write([new ClipboardItem({'image/png': currentBlob})]);
      showStatus('success', 'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    } catch { showStatus('error', 'âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—'); }
  });

  $('btnReset').addEventListener('click', () => {
    results.classList.remove('active');
    processing.classList.remove('active');
    inputSection.classList.remove('hidden');
    statusEl.classList.remove('active');
    currentBlob = null;
  });

  function showStatus(type, msg) {
    if (!msg) { statusEl.classList.remove('active'); return; }
    statusEl.className = 'status active ' + type;
    statusEl.textContent = msg;
    if (type === 'success') setTimeout(() => statusEl.classList.remove('active'), 5000);
  }
</script>
</body>
</html>
